// Aura Voice Chat - Prisma Schema
// Developer: Hawkaye Visions LTD â€” Pakistan
// PostgreSQL Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id                String   @id @default(uuid())
  cognitoSub        String?  @unique @map("cognito_sub")
  username          String   @unique
  displayName       String?  @map("display_name")
  email             String?  @unique
  phoneNumber       String?  @unique @map("phone_number")
  avatarUrl         String?  @map("avatar_url")
  bio               String?
  gender            String?
  birthday          DateTime?
  country           String?
  language          String?  @default("en")
  
  // Account Status
  status            String   @default("active") // active, suspended, banned
  role              String   @default("user") // user, guide, admin, country_admin, seller, owner
  isVerified        Boolean  @default(false) @map("is_verified")
  isOnline          Boolean  @default(false) @map("is_online")
  lastLoginAt       DateTime? @map("last_login_at")
  
  // Currency
  coins             BigInt   @default(0)
  diamonds          BigInt   @default(0)
  beans             BigInt   @default(0)
  
  // Progression
  level             Int      @default(1)
  exp               BigInt   @default(0)
  vipTier           Int      @default(0) @map("vip_tier")
  vipExpireAt       DateTime? @map("vip_expire_at")
  
  // Reseller
  resellerTier      Int?     @map("reseller_tier")
  resellerBalance   Decimal? @default(0) @map("reseller_balance") @db.Decimal(15, 2)
  
  // Statistics
  followersCount    Int      @default(0) @map("followers_count")
  followingCount    Int      @default(0) @map("following_count")
  giftsReceived     BigInt   @default(0) @map("gifts_received")
  giftsSent         BigInt   @default(0) @map("gifts_sent")
  
  // Moderation
  warnings          Int      @default(0)
  mutedUntil        DateTime? @map("muted_until")
  banReason         String?  @map("ban_reason")
  isPermanentBan    Boolean  @default(false) @map("is_permanent_ban")
  
  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  ownedRooms        Room[]   @relation("RoomOwner")
  roomMembers       RoomMember[]
  sentMessages      Message[] @relation("MessageSender")
  transactions      Transaction[]
  wallet            Wallet?
  familyMembers     FamilyMember[]
  medals            UserMedal[]
  rewards           UserReward[]
  gameHistory       GameHistory[]
  referralsMade     Referral[] @relation("ReferralFrom")
  referredBy        Referral? @relation("ReferredUser")
  kyc               KYC?
  
  @@map("users")
}

// ============================================
// Room Management
// ============================================

model Room {
  id                String   @id @default(uuid())
  name              String
  description       String?
  coverUrl          String?  @map("cover_url")
  type              String   @default("voice") // voice, video, music, party
  category          String?
  language          String?
  
  // Settings
  maxMembers        Int      @default(50) @map("max_members")
  maxSeats          Int      @default(8) @map("max_seats")
  isPublic          Boolean  @default(true) @map("is_public")
  password          String?
  
  // Status
  status            String   @default("active") // active, closed, suspended
  isLive            Boolean  @default(false) @map("is_live")
  currentMembers    Int      @default(0) @map("current_members")
  
  // Owner
  ownerId           String   @map("owner_id")
  owner             User     @relation("RoomOwner", fields: [ownerId], references: [id])
  
  // Statistics
  totalGifts        BigInt   @default(0) @map("total_gifts")
  totalVisits       Int      @default(0) @map("total_visits")
  
  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  members           RoomMember[]
  messages          Message[]
  
  @@map("rooms")
}

model RoomMember {
  id                String   @id @default(uuid())
  roomId            String   @map("room_id")
  userId            String   @map("user_id")
  role              String   @default("member") // owner, admin, moderator, member
  seatNumber        Int?     @map("seat_number")
  isMuted           Boolean  @default(false) @map("is_muted")
  isBanned          Boolean  @default(false) @map("is_banned")
  joinedAt          DateTime @default(now()) @map("joined_at")
  
  room              Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([roomId, userId])
  @@map("room_members")
}

// ============================================
// Messages
// ============================================

model Message {
  id                String   @id @default(uuid())
  roomId            String   @map("room_id")
  senderId          String   @map("sender_id")
  type              String   @default("text") // text, image, audio, gift, system
  content           String?
  metadata          Json?
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  room              Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender            User     @relation("MessageSender", fields: [senderId], references: [id])
  
  @@map("messages")
}

// ============================================
// Family/Clan System
// ============================================

model Family {
  id                String   @id @default(uuid())
  name              String   @unique
  description       String?
  avatarUrl         String?  @map("avatar_url")
  badgeUrl          String?  @map("badge_url")
  isPublic          Boolean  @default(true) @map("is_public")
  announcement      String?
  
  ownerId           String   @map("owner_id")
  level             Int      @default(1)
  exp               BigInt   @default(0)
  totalContribution BigInt   @default(0) @map("total_contribution")
  maxMembers        Int      @default(50) @map("max_members")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  members           FamilyMember[]
  
  @@map("families")
}

model FamilyMember {
  id                String   @id @default(uuid())
  familyId          String   @map("family_id")
  userId            String   @map("user_id")
  role              String   @default("member") // owner, admin, moderator, member
  contribution      BigInt   @default(0)
  joinedAt          DateTime @default(now()) @map("joined_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  family            Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([familyId, userId])
  @@map("family_members")
}

// ============================================
// Wallet & Transactions
// ============================================

model Wallet {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  
  // Balances
  coins             BigInt   @default(0)
  diamonds          BigInt   @default(0)
  beans             BigInt   @default(0)
  pendingWithdraw   Decimal  @default(0) @map("pending_withdraw") @db.Decimal(15, 2)
  
  // Statistics
  totalDeposited    Decimal  @default(0) @map("total_deposited") @db.Decimal(15, 2)
  totalWithdrawn    Decimal  @default(0) @map("total_withdrawn") @db.Decimal(15, 2)
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("wallets")
}

model Transaction {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  type              String   // deposit, withdrawal, transfer, gift, purchase, reward, exchange
  status            String   @default("completed") // pending, completed, failed, cancelled
  
  currency          String   // coins, diamonds, beans, usd
  amount            Decimal  @db.Decimal(15, 2)
  fee               Decimal? @db.Decimal(15, 2)
  
  fromUserId        String?  @map("from_user_id")
  toUserId          String?  @map("to_user_id")
  
  description       String?
  metadata          Json?
  reference         String?  @unique
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  user              User     @relation(fields: [userId], references: [id])
  
  @@map("transactions")
}

// ============================================
// VIP System
// ============================================

model VIPConfig {
  id                String   @id @default(uuid())
  tier              Int      @unique
  name              String
  requiredDiamonds  BigInt   @map("required_diamonds")
  durationDays      Int      @map("duration_days")
  
  // Benefits
  dailyCoins        Int      @default(0) @map("daily_coins")
  entryEffect       String?  @map("entry_effect")
  chatBubble        String?  @map("chat_bubble")
  badge             String?
  frame             String?
  benefits          Json?
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("vip_configs")
}

// ============================================
// Level System
// ============================================

model LevelConfig {
  id                String   @id @default(uuid())
  level             Int      @unique
  requiredExp       BigInt   @map("required_exp")
  title             String?
  badgeUrl          String?  @map("badge_url")
  benefits          Json?
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("level_configs")
}

// ============================================
// Medals/Badges
// ============================================

model Medal {
  id                String   @id @default(uuid())
  name              String   @unique
  description       String?
  iconUrl           String   @map("icon_url")
  category          String   // achievement, event, special, vip, level
  rarity            String   @default("common") // common, rare, epic, legendary
  
  // Requirements
  requirements      Json?
  
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  
  users             UserMedal[]
  
  @@map("medals")
}

model UserMedal {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  medalId           String   @map("medal_id")
  isDisplayed       Boolean  @default(true) @map("is_displayed")
  earnedAt          DateTime @default(now()) @map("earned_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  medal             Medal    @relation(fields: [medalId], references: [id])
  
  @@unique([userId, medalId])
  @@map("user_medals")
}

// ============================================
// Rewards System
// ============================================

model Reward {
  id                String   @id @default(uuid())
  name              String
  description       String?
  type              String   // daily, weekly, achievement, event, login_streak
  
  // Rewards
  coins             Int      @default(0)
  diamonds          Int      @default(0)
  exp               Int      @default(0)
  items             Json?
  
  // Requirements
  requirements      Json?
  
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  
  claims            UserReward[]
  
  @@map("rewards")
}

model UserReward {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  rewardId          String   @map("reward_id")
  claimedAt         DateTime @default(now()) @map("claimed_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reward            Reward   @relation(fields: [rewardId], references: [id])
  
  @@map("user_rewards")
}

// ============================================
// Events
// ============================================

model Event {
  id                String   @id @default(uuid())
  name              String
  description       String?
  type              String   // gift_race, level_race, family_battle, special
  
  startDate         DateTime @map("start_date")
  endDate           DateTime @map("end_date")
  
  rules             Json?
  rewards           Json?
  
  status            String   @default("draft") // draft, active, ended
  createdBy         String?  @map("created_by")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  participants      EventParticipant[]
  
  @@map("events")
}

model EventParticipant {
  id                String   @id @default(uuid())
  eventId           String   @map("event_id")
  userId            String   @map("user_id")
  score             BigInt   @default(0)
  rank              Int?
  rewardClaimed     Boolean  @default(false) @map("reward_claimed")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  event             Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, userId])
  @@map("event_participants")
}

// ============================================
// Games
// ============================================

model Game {
  id                String   @id @default(uuid())
  type              String   // lucky_777_pro, lucky_77_pro, greedy_baby, lucky_fruit, gift_wheel
  name              String
  minBet            BigInt?  @map("min_bet")
  maxBet            BigInt?  @map("max_bet")
  spinCost          BigInt?  @map("spin_cost")
  advancedSpinCost  BigInt?  @map("advanced_spin_cost")
  config            Json?
  
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("games")
}

model GameHistory {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  gameType          String   @map("game_type")
  betAmount         BigInt   @map("bet_amount")
  winAmount         BigInt   @map("win_amount")
  result            Json?
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("game_history")
}

model GiftWheelRecord {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  drawType          String   @map("draw_type") // standard, advanced
  drawCount         Int      @map("draw_count")
  items             Json     // Array of won items
  totalValue        BigInt   @map("total_value")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  @@map("gift_wheel_records")
}

model Jackpot {
  id                String   @id @default(uuid())
  gameType          String   @unique @map("game_type")
  amount            BigInt   @default(0)
  lastWinnerId      String?  @map("last_winner_id")
  lastWonAt         DateTime? @map("last_won_at")
  
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("jackpots")
}

// ============================================
// Referral System
// ============================================

model Referral {
  id                String   @id @default(uuid())
  referrerId        String   @map("referrer_id")
  referredUserId    String   @unique @map("referred_user_id")
  code              String
  status            String   @default("pending") // pending, completed, rewarded
  
  rewardGiven       Boolean  @default(false) @map("reward_given")
  rewardAmount      Int?     @map("reward_amount")
  
  createdAt         DateTime @default(now()) @map("created_at")
  completedAt       DateTime? @map("completed_at")
  
  referrer          User     @relation("ReferralFrom", fields: [referrerId], references: [id])
  referredUser      User     @relation("ReferredUser", fields: [referredUserId], references: [id])
  
  @@map("referrals")
}

// ============================================
// KYC Verification
// ============================================

model KYC {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  
  documentType      String   @map("document_type") // passport, id_card, driver_license
  documentNumber    String?  @map("document_number")
  documentFrontUrl  String?  @map("document_front_url")
  documentBackUrl   String?  @map("document_back_url")
  selfieUrl         String?  @map("selfie_url")
  
  fullName          String?  @map("full_name")
  dateOfBirth       DateTime? @map("date_of_birth")
  nationality       String?
  address           String?
  
  status            String   @default("pending") // pending, approved, rejected
  rejectionReason   String?  @map("rejection_reason")
  reviewedBy        String?  @map("reviewed_by")
  reviewedAt        DateTime? @map("reviewed_at")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("kyc_verifications")
}

// ============================================
// System Settings
// ============================================

model SystemSetting {
  id                String   @id @default(uuid())
  key               String   @unique
  value             Json
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@map("system_settings")
}

// ============================================
// Admin Logs
// ============================================

model AdminLog {
  id                String   @id @default(uuid())
  adminId           String   @map("admin_id")
  actionType        String   @map("action_type")
  targetType        String?  @map("target_type")
  targetId          String?  @map("target_id")
  description       String?
  metadata          Json?
  ipAddress         String?  @map("ip_address")
  
  createdAt         DateTime @default(now()) @map("created_at")
  
  @@map("admin_logs")
}
